#!/usr/bin/env bash
# This script installs and configures HAProxy as a load balancer for web-01 and web-02.
# Update and install HAProxy on the load balancer

# Exit on any error
set -e

# Update package lists
echo "Updating package lists..."
sudo apt update -y

# Upgrade packages (optional)
echo "Upgrading packages..."
sudo apt upgrade -y

# Install HAProxy
echo "Installing HAProxy..."
sudo apt install -y haproxy

# Enable HAProxy to start on boot
echo "Enabling HAProxy service to start on boot..."
sudo systemctl enable haproxy

# Configure HAProxy to load balance between web-01 and web-02
echo "Configuring HAProxy..."
cat <<EOL | sudo tee /etc/haproxy/haproxy.cfg > /dev/null
global
    log /dev/log    local0
    maxconn 200

defaults
    log     global
    option  httplog
    timeout connect 5000ms
    timeout client  50000ms
    timeout server  50000ms

frontend http_front
    bind *:80
    acl url_static path_end .jpg .jpeg .png .gif .css .js
    use_backend static_files if url_static
    default_backend web_servers

backend web_servers
    balance roundrobin
    server web-01 100.25.0.82:80 check
    server web-02 54.87.216.188:80 check

# Enable health checks for web-01 and web-02
backend static_files
    balance roundrobin
    server web-01 100.25.0.82:80 check
    server web-02 54.87.216.188:80 check
EOL

# Restart HAProxy to apply the new configuration
echo "Restarting HAProxy..."
sudo systemctl restart haproxy

# Verify HAProxy status
echo "Verifying HAProxy service status..."
sudo systemctl status haproxy

# Show HAProxy stats to ensure it's running properly
echo "HAProxy is now configured. Checking the load balancer stats..."
curl -I http://localhost
