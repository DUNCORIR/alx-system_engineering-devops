#!/usr/bin/env bash
# The script ensures Nginx is running and listening on port 80

set -e  # Exit on error

# Update package lists
echo "Updating package lists..."
sudo apt update -y

# Install Nginx if not installed
echo "Installing Nginx..."
sudo apt install -y nginx

# Ensure Nginx is enabled and starts on boot
echo "Enabling Nginx..."
sudo systemctl enable nginx

# Allow port 80 through UFW firewall (if applicable)
echo "Allowing port 80 through firewall..."
sudo ufw allow 80/tcp || true  # Ignore errors if UFW is not installed

# Ensure Nginx is running
echo "Starting Nginx..."
sudo systemctl restart nginx

# Verify Nginx configuration syntax
echo "Checking Nginx configuration..."
sudo nginx -t

# Ensure Nginx listens on port 80 on all IPv4 addresses
echo "Verifying Nginx is listening on port 80..."
LISTEN_COUNT=$(sudo netstat -tulnp | grep ":80 " | wc -l)

if [ "$LISTEN_COUNT" -ge 2 ]; then
    echo "Nginx is properly running and listening on port 80."
else
    echo "Error: Nginx is not listening correctly. Restarting again..."
    sudo systemctl restart nginx
    LISTEN_COUNT=$(sudo netstat -tulnp | grep ":80 " | wc -l)
    if [ "$LISTEN_COUNT" -ge 2 ]; then
        echo "Nginx is now fixed and listening on port 80."
    else
        echo "Critical Error: Nginx is still not listening on port 80."
        exit 1
    fi
fi